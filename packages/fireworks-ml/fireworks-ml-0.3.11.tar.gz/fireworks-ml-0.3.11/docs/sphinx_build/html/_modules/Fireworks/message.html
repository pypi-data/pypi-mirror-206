
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Fireworks.message &#8212; Fireworks 0.2.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Fireworks</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Project.html">Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../License.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Fireworks.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for Fireworks.message</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Hashable</span>
<span class="kn">from</span> <span class="nn">Fireworks.utils</span> <span class="k">import</span> <span class="n">index_to_list</span><span class="p">,</span> <span class="n">slice_length</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Messages passed between objects in this framework are represented as dictionaries of tensors.</span>
<span class="sd">This is analogous to a pandas dataframe, except the elements of the table are tensors rather than series objects. Because</span>
<span class="sd">a message is just a dictionary, it can be converted to a dataframe. The inverse will only be possible if every element</span>
<span class="sd">of the dataframe can be tensorized (strings can&#39;t be converted to tensors.)</span>

<span class="sd">This file contains utility functions for working with messages. In order to avoid coupling this framework to a message class,</span>
<span class="sd">messages are represented as standard python dicts and are assumed to conform the necessary interface.</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Message"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message">[docs]</a><span class="k">class</span> <span class="nc">Message</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Message is a class for representing data in a way that can be consumed by different analysis pipelines in python. It does this by</span>
<span class="sd">    representing the data as a dictionary of arrays. This is the same approach that pandas takes, but Messages are specifically designed to</span>
<span class="sd">    be used with pytorch, in which the core data structure is a tensor, which cannot be mixed into a pandas dataframe.</span>
<span class="sd">    Hence, a Message has two elements: a TensorMessage which specifically stores tensor objects and a dataframe which can be used for handling</span>
<span class="sd">    any other type of array data. With this structure, you could put your training data in as a TensorMessage and any associated metadata as</span>
<span class="sd">    the df and lump all of that into a message. All of the existing df methods can be run on the metadata, and any pytorch operations can be</span>
<span class="sd">    performed on the tensor part.</span>

<span class="sd">    Messages support operations such as appending one message to another, joining two messages along keys, applying maps to the message&#39;s values,</span>
<span class="sd">    and equality checks.</span>

<span class="sd">    Additionally, messages behave as much as possible like dicts. In many scenarios, a dict will be able to substitute for a message and vice-versa.</span>
<span class="sd">    For example, for preparing batches to feed into an RNN to classify DNA sequences, one could create a Message like this:</span>

<span class="sd">    ::</span>

<span class="sd">        my_message = Message({</span>
<span class="sd">        &#39;embedded_sequences&#39;: torch.Tensor([...]),</span>
<span class="sd">        &#39;labels&#39;: torch.LongTensor([...]),</span>
<span class="sd">        &#39;raw_sequences&#39;: [&#39;TCGA...&#39;,...,],</span>
<span class="sd">        ...})</span>

<span class="sd">    The Message constructor will parse this dictionary and store the labels and embedded sequences inside a TensorMessage and the raw_sequences and other metadata in the dataframe.</span>

<span class="sd">    Now we can access elements of this Message:</span>

<span class="sd">    ::</span>

<span class="sd">        my_message[0]</span>
<span class="sd">        my_message[2:10]</span>
<span class="sd">        my_message[&#39;labels&#39;]</span>
<span class="sd">        len(my_message)</span>

<span class="sd">    We can also move tensors to the GPU and back:</span>

<span class="sd">    ::</span>

<span class="sd">        my_message.cpu()</span>
<span class="sd">        my_message.cuda(device_num=1) # Defaults to 0 for device number</span>
<span class="sd">        my_message.cuda(keys=[&#39;labels&#39;]) # Can specify only certain columns to move if desired</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a message</span>
<span class="sd">        If *args is empty --&gt; empty message</span>
<span class="sd">        If *args is two args --&gt; construct a message assuming arg0 is tensors and arg1 is dataframe</span>
<span class="sd">        Alternatively, tensors and dataframes can be specified with kwargs (tensors  = ... and df = ...)</span>
<span class="sd">        If *args has __getitem__ and keys() attributes --&gt; construct a message from elements of dict, separating tensors from pd series</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot; Init must be idempotent, attempt to perform type conversions as necessary, and compute/check length. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tensors</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;tensors&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">tensors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;tensors&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;df&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tensors</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Identify tensors and separate them out</span>
            <span class="c1"># The argument may be an existing Message/TensorMessage</span>
            <span class="c1"># TODO: Implement ability to create a message from a list of messages/dicts</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">Message</span><span class="p">:</span>
                <span class="n">tensors</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tensor_message</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">df</span>

            <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tensors</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">df</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">tensors</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">extract_tensors</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span> <span class="o">=</span> <span class="n">TensorMessage</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span> <span class="c1"># The TensorMessage constructor will handle type conversions as needed.</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Message</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dataframe</span><span class="p">()</span> <span class="c1"># Pull out the df from the message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># Ensure columns are in the same order always</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_length</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>

<div class="viewcode-block" id="Message.check_length"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.check_length">[docs]</a>    <span class="k">def</span> <span class="nf">check_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that lengths of the internal tensor_message and dataframe are the same and equalto self.len</span>
<span class="sd">        If one of the two is empty (length 0) then, that is fine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Every element of the message, including tensors and arrays, must have the same length unless one or both are None.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Must give sensible results for online and streaming type datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Two messages are equal if they have the same keys, and for each key the elements are equal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tensors_equal</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">)</span>
        <span class="n">df_equal</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">df</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">tensors_equal</span> <span class="ow">and</span> <span class="n">df_equal</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            index: An integer, slice, or list of integer indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getindex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getindex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="c1"># Must account for list of indices and list of strings</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Message</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span> <span class="c1"># Is index</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getindex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span> <span class="c1"># Is list of column names</span>
                <span class="k">return</span> <span class="n">Message</span><span class="p">({</span><span class="n">s</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">index</span><span class="p">},</span> <span class="n">length</span> <span class="o">=</span> <span class="n">slice_length</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not a column name or a valid index for this message.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_getindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a submessage based on requested index.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: An integer, slice, or list of integer indices.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">length</span><span class="o">=</span><span class="n">slice_length</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="n">slice_length</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">length</span><span class="o">=</span><span class="n">slice_length</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            index: An integer, slice, or list of integer indices.</span>
<span class="sd">            value: The value to set the index to. Must be an object that can be fed to the Message initializer and produce a message</span>
<span class="sd">                with the same length as the index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="c1"># Check if the update would require moving a column from df to tensor_message or vice-versa, in which case, delete the original</span>
            <span class="c1"># and then insert the new value into the correct location.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="ow">and</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="ow">and</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="c1"># Update or insert</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="c1"># This will trigger a length check automatically</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="c1"># Check value before updating df</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set value </span><span class="si">{0}</span><span class="s2"> of length </span><span class="si">{1}</span><span class="s2"> to column name </span><span class="si">{2}</span><span class="s2"> for message with length </span><span class="si">{3}</span><span class="s2">. Lengths of all columns </span><span class="se">\</span>
<span class="s2">                must be the same.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tensor_message</span>
            <span class="n">value</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">df</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tensor_message</span>
            <span class="n">value</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">df</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span> <span class="c1"># Update multiple columns at once with a dict</span>
                    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tensor_message</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not a valid index.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No index specified.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if index is a string (column name) or index (row, range of rows) and deletes the appropriate part of the message.</span>
<span class="sd">        If index is a list, it can be a list of either column names or indices.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: An integer, slice, or list of integer indices.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span> <span class="c1"># Delete column</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Column </span><span class="si">{0}</span><span class="s2"> not found in message.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span> <span class="c1"># Delete single row</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Cannot delete element </span><span class="si">{0}</span><span class="s2"> from message with length </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delindex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delindex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">):</span> <span class="c1"># Otherwise list is empty and do nothing</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span> <span class="c1"># Delete columns</span>
                    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Column </span><span class="si">{0}</span><span class="s2"> not found in message.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span> <span class="c1"># Delete multiple indices</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Cannot delete element </span><span class="si">{0}</span><span class="s2"> from message with length </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_delindex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not a column(s) or index in this message.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_delindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes the given index after it has been validated by __delitem__</span>

<span class="sd">        Args:</span>
<span class="sd">            index: An integer, slice, or list of integer indices.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">length</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="ow">or</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Message with </span><span class="se">\n</span><span class="s2"> Tensors: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{0}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> Metadata: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns names of tensors in TensorMessage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

<div class="viewcode-block" id="Message.keys"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns names of tensors in TensorMessage</span>
<span class="sd">        Note: This is the same as self.columns</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns index for internal tensors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: Index currently has no meaning, because messages are currently required to be indexed from 0:length</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>

<div class="viewcode-block" id="Message.append"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compines messages together.</span>
<span class="sd">        Should initialize other if not a message already.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: The message to append to self. Must have the same keys as self so that in the resulting Message,</span>
<span class="sd">                every column continues to have the same length as needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">other</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="c1"># Check if self is empty, and if so, replace it with other.</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">empty_message</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">other</span>

        <span class="n">appended_tensors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">)</span>
        <span class="n">appended_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Message</span><span class="p">(</span><span class="n">appended_tensors</span><span class="p">,</span> <span class="n">appended_df</span><span class="p">)</span></div>

<div class="viewcode-block" id="Message.merge"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines messages horizontally by producing a message with the keys/values of both.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: The message to merge with self. Must have different keys and the same length as self to ensure length consistencies.</span>
<span class="sd">                Alternatively, if either self or other have an empty TensorMessage or df, then they can be merged together safely as long</span>
<span class="sd">                as the resulting Message has a consistent length.</span>
<span class="sd">                For example:</span>
<span class="sd">                ::</span>
<span class="sd">                    message_a = Message({&#39;a&#39;: [1,2,3]}) # This is essentially a DataFrame</span>
<span class="sd">                    message_b = Message({&#39;b&#39;: torch.Tensor([1,2,3])}) # This is essentially a TensorMessage</span>
<span class="sd">                    message_c = Message_a.merge(message_b) # This works</span>

<span class="sd">        Returns:</span>
<span class="sd">            message: The concatenated Message containing columns from self and other.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Message</span><span class="p">({</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">,</span> <span class="o">**</span><span class="n">other</span><span class="o">.</span><span class="n">tensor_message</span><span class="p">},</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">other</span><span class="o">.</span><span class="n">df</span><span class="p">})</span></div>

<div class="viewcode-block" id="Message.map"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.map">[docs]</a>    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies function mapping to message. If mapping is a dict, then maps will be applied to the correspondign keys as columns, leaving</span>
<span class="sd">        columns not present in mapping untouched.</span>
<span class="sd">        In otherwords, mapping would be a dict of column_name:functions specifying the mappings.</span>

<span class="sd">        Args:</span>

<span class="sd">            mapping: Can either be a dict mapping column names to functions that should be applied to those columns, or a single function.</span>
<span class="sd">                In the latter case, the mapping function will be applied to every column.</span>

<span class="sd">        Returns:</span>

<span class="sd">            message: A Message with the column:value pairs produced by the mapping.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Message</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mapping</span> <span class="k">else</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Message</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span></div>

<div class="viewcode-block" id="Message.tensors"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.tensors">[docs]</a>    <span class="k">def</span> <span class="nf">tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return tensors associated with message as a tensormessage.</span>
<span class="sd">        If keys are specified, returns tensors associated with those keys, performing conversions as needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: Keys to get. Default = None, in which case all tensors are returned as a TensorMessage.</span>
<span class="sd">                If columns corresponding to requested keys are not tensors, they will be converted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tensors (TensorMessage): A TensorMessage containing the tensors requested.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TensorMessage</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">})</span></div>

<div class="viewcode-block" id="Message.dataframe"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns message as a dataframe. If keys are specified, only returns those keys as a dataframe.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: Keys to get. Default = None, in which case all non-tensors are returned as a DataFrame.</span>
<span class="sd">                If columns corresponding to requested keys are tensors, they will be converted (to np.arrays).</span>

<span class="sd">        Returns:</span>
<span class="sd">            df (pd.DataFrame): A DataFrame containing the columns requested.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">})</span></div>

<div class="viewcode-block" id="Message.to_dataframe"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns message with columns indicated by keys converted to DataFrame. If keys is None, all tensors are converted.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: Keys to get. Default = None, in which case all tensors are mapped to DataFrame.</span>

<span class="sd">        Returns:</span>
<span class="sd">            message: A Message in which the desired columns are DataFrames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Message.to_tensors"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.to_tensors">[docs]</a>    <span class="k">def</span> <span class="nf">to_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># TODO: Test</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns message with columns indicated by keys converted to Tensors. If keys is None, all columns are converted.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: Keys to get. Default = None, in which case all columns are mapped to Tensor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            message: A Message in which the desired columns are Tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">tensor_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensors</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor_message</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Message.permute"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.permute">[docs]</a>    <span class="k">def</span> <span class="nf">permute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reorders elements of message based on index.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: A valid index for the message.</span>

<span class="sd">        Returns:</span>
<span class="sd">            message: A new Message with the elements arranged according to the input index.</span>
<span class="sd">                For example,</span>
<span class="sd">                ::</span>
<span class="sd">                message_a = Message({&#39;a&#39;:[1,2,3]})</span>
<span class="sd">                message_b = message_a.permute([2,1,0])</span>
<span class="sd">                message_c = Message({&#39;a&#39;: [3,2,1]})</span>
<span class="sd">                message_b == message_c</span>

<span class="sd">                The last statement will evaluate to True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">tensor_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="n">df_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_index</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor_message</span><span class="p">):</span>
            <span class="n">tensor_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Message</span><span class="p">(</span><span class="n">tensor_message</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span></div>

<div class="viewcode-block" id="Message.cpu"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.cpu">[docs]</a>    <span class="k">def</span> <span class="nf">cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves tensors to system memory. Can specify which ones to move by specifying keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: Keys to move to system memory. Default = None, meaning all columns are moved.</span>

<span class="sd">        Returns:</span>
<span class="sd">            message (Message): Moved message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">cpu</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span></div>

<div class="viewcode-block" id="Message.cuda"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.Message.cuda">[docs]</a>    <span class="k">def</span> <span class="nf">cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves tensors to gpu with given device number. Can specify which ones to move by specifying keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            device (int): CUDA device number to use. Default = 0.</span>
<span class="sd">            keys: Keys to move to GPU. Default = None, meaning all columns are moved.</span>

<span class="sd">        Returns:</span>
<span class="sd">            message (Message): Moved message</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="TensorMessage"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.TensorMessage">[docs]</a><span class="k">class</span> <span class="nc">TensorMessage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A TensorMessage is a class for representing data meant for consumption by pytorch as a dictionary of tensors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">map_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initizes TensorMessage, performing type conversions as necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_dict</span> <span class="o">=</span> <span class="n">map_dict</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">message_dict</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Message</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span> <span class="o">=</span> <span class="n">message_dict</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">tensor_dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">message_dict</span><span class="o">.</span><span class="n">tensor_message</span><span class="o">.</span><span class="n">length</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">message_dict</span><span class="p">)</span> <span class="ow">is</span> <span class="n">TensorMessage</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span> <span class="o">=</span> <span class="n">message_dict</span><span class="o">.</span><span class="n">tensor_dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">message_dict</span><span class="o">.</span><span class="n">length</span>
        <span class="k">elif</span> <span class="n">message_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">message_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Make value list like if not already. For example, for length-1 messages.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
                <span class="c1"># Apply (optional) mappings. For example, to specify a torch.BytesTensor instead of a FloatTensor.</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_dict</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">map_dict</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_dict</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
                <span class="c1"># Convert to tensor if not already</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="p">(</span><span class="s2">&quot;Elements of a message must be torch tensors. Tried to convert value associated with key </span><span class="si">{0}</span><span class="s2"> &quot;</span> <span class="o">+</span> \
                        <span class="s2">&quot;but got error: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                <span class="c1"># Make sure is not a 0-dim tensor</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([]):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">compute_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span> <span class="c1"># TODO: Add support for nonstandard slices (0:, :-k, etc.)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="c1"># This will raise a key error if column not present</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">TensorMessage</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">TensorMessage</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span> <span class="c1"># Check if list of column names or indices</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">TensorMessage</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">index</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">TensorMessage</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Empty list</span>
                <span class="k">return</span> <span class="n">TensorMessage</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not a column name or a valid index for this message.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="c1"># Check length</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set column </span><span class="si">{0}</span><span class="s2"> to value </span><span class="si">{1}</span><span class="s2"> with length </span><span class="si">{2}</span><span class="s2"> for message with length </span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">TensorMessage</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="c1"># BUG: Out of bound slice queries return an empty Message instead of raising an error.</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span> <span class="c1"># List of column names</span>
                    <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="c1"># This will trigger recursive call to __setitem__</span>
                <span class="k">elif</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">TensorMessage</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="c1"># Tensors can be indexed by list</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not a valid index.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Empty list</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No index specified for setitem.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span> <span class="c1"># BUG: delitem raises sigfaults when called on a tensor.</span>

        <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="c1"># Will automatically throw a KeyError if not in the dict</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delindex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">:</span>
            <span class="c1"># if max(index.stop, index.start) &gt; self.length:</span>
            <span class="c1">#     raise IndexError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delslice</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">tt</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dellist</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># If you&#39;ve deleted the last column, the length is now 0 #TODO: Test this</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_delindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes single row corresponding to a single index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Deleting the only row of a 1-row Message</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">new_length</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Deleting first row of an n-row message</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">]</span><span class="o">.</span><span class="n">tensor_dict</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">new_length</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># Deleting the last row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tensor_dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">new_length</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Delete an in-between row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span> <span class="o">=</span> <span class="n">TensorMessage</span><span class="p">(</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">]]))</span><span class="o">.</span><span class="n">tensor_dict</span>

    <span class="k">def</span> <span class="nf">_delslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orange</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes rows corresponding to a slice object.</span>
<span class="sd">        This involves finding the complementary set of indices and returning those.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">orange</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">orange</span><span class="o">.</span><span class="n">step</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># Unit step size</span>
            <span class="c1"># NOTE: We will treat -1 and 1 as the same for now</span>
            <span class="k">if</span> <span class="n">orange</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># Is backwards</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">orange</span><span class="o">.</span><span class="n">stop</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">orange</span><span class="o">.</span><span class="n">start</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">orange</span><span class="o">.</span><span class="n">start</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">orange</span><span class="o">.</span><span class="n">step</span>

            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Invalid slice </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">orange</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bottom_message</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">start</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bottom_message</span> <span class="o">=</span> <span class="n">TensorMessage</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="ow">and</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                <span class="n">top_message</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">stop</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">top_message</span> <span class="o">=</span> <span class="n">TensorMessage</span><span class="p">()</span>

            <span class="c1"># TODO: Have to flip response if a downward slice is requested</span>
            <span class="n">new_message</span> <span class="o">=</span> <span class="n">TensorMessage</span><span class="p">(</span><span class="n">cat</span><span class="p">([</span><span class="n">bottom_message</span><span class="p">,</span> <span class="n">top_message</span><span class="p">]))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span> <span class="o">=</span> <span class="n">new_message</span><span class="o">.</span><span class="n">tensor_dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">new_message</span><span class="o">.</span><span class="n">length</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># Step count is some number that must be accounted for</span>
            <span class="n">listy</span> <span class="o">=</span> <span class="n">slice_to_list</span><span class="p">(</span><span class="n">orange</span><span class="p">)</span> <span class="c1"># NOTE: This is low priority so for now we just convert to list and delete that way</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dellist</span><span class="p">(</span><span class="n">listy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dellist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes rows corresponding to indices in a list.</span>
<span class="sd">        This involves finding the complementary set of indices and returning those.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">complement</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">listy</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">complement</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">complement</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">TensorMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">TensorMessage</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">),</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_dict</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Hashable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="TensorMessage.keys"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.TensorMessage.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Two tensor messages are equivalent if they have the same keys and their elements are equal.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">keys_equal</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keys_equal</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">other</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;TensorMessage: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns names of tensors in TensorMessage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns index for internal tensors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: Index currently has no meaning, because messages are currently required to be indexed from 0:length</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>

<div class="viewcode-block" id="TensorMessage.append"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.TensorMessage.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note if the target message has additional keys, those will be dropped.</span>
<span class="sd">        The target message must also have every key present in this message in</span>
<span class="sd">        order to avoid an value error due to length differences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">TensorMessage</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="c1"># If self is empty, just replace it with other.</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">empty_tensor_message</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">TensorMessage</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">other</span><span class="p">[</span><span class="n">key</span><span class="p">]])</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()})</span></div>

<div class="viewcode-block" id="TensorMessage.merge"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.TensorMessage.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines self with other into a message with the keys of both.</span>
<span class="sd">        self and other must have distinct keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">TensorMessage</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TensorMessage</span><span class="p">({</span><span class="o">**</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">other</span><span class="p">})</span></div>

<div class="viewcode-block" id="TensorMessage.permute"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.TensorMessage.permute">[docs]</a>    <span class="k">def</span> <span class="nf">permute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rearranges elements of TensorMessage to align with new index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">permutation</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">permutation</span></div>

<div class="viewcode-block" id="TensorMessage.cuda"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.TensorMessage.cuda">[docs]</a>    <span class="k">def</span> <span class="nf">cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves all tensors in TensorMessage to cuda device specified by device number. Specify keys to limit the transformation</span>
<span class="sd">        to specific keys only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="TensorMessage.cpu"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.TensorMessage.cpu">[docs]</a>    <span class="k">def</span> <span class="nf">cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves all tensors in TensorMessage to cpu. Specify keys to limit the transformation</span>
<span class="sd">        to specific keys only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div></div>

<div class="viewcode-block" id="compute_length"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.compute_length">[docs]</a><span class="k">def</span> <span class="nf">compute_length</span><span class="p">(</span><span class="n">of_this</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Of_this is a dict of listlikes. This function computes the length of that object, which is the length of all of the listlikes, which</span>
<span class="sd">    are assumed to be equal. This also implicitly checks for the lengths to be equal, which is necessary for Message/TensorMessage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">of_this</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">lengths</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="c1"># An empty dict has 0 length.</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lengths</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Lengths are not all the same</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Every element of dict must have the same length.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="extract_tensors"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.extract_tensors">[docs]</a><span class="k">def</span> <span class="nf">extract_tensors</span><span class="p">(</span><span class="n">from_this</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dict from_this, returns two dicts, one containing all of the key/value pairs corresponding to tensors in from_this, and the other</span>
<span class="sd">    containing the remaining pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tensor_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">from_this</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">}</span>
    <span class="n">other_keys</span> <span class="o">=</span> <span class="n">from_this</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">tensor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">tensor_dict</span> <span class="k">else</span> <span class="n">from_this</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">other_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">from_this</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">other_keys</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">tensor_dict</span><span class="p">,</span> <span class="n">other_dict</span></div>

<div class="viewcode-block" id="slice_to_list"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.slice_to_list">[docs]</a><span class="k">def</span> <span class="nf">slice_to_list</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a slice object to a list of indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">step</span> <span class="ow">or</span> <span class="mi">1</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">start</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stop</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">step</span><span class="p">)]</span></div>

<div class="viewcode-block" id="complement"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.complement">[docs]</a><span class="k">def</span> <span class="nf">complement</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given an index, returns all indices between 0 and n that are not in the index. &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">slice</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">slice_to_list</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">indices</span><span class="p">]</span>

    <span class="n">complement</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">complement</span></div>

<div class="viewcode-block" id="cat"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.cat">[docs]</a><span class="k">def</span> <span class="nf">cat</span><span class="p">(</span><span class="n">list_of_args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenates messages in list_of_args into one message.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">list_of_args</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">return</span> <span class="n">Message</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">list_of_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">list_of_args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="merge"><a class="viewcode-back" href="../../Fireworks.html#Fireworks.message.merge">[docs]</a><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">list_of_args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges messages in list_of_args into one message with all the keys combined.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">list_of_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">list_of_args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">m</span></div>

<span class="n">empty_tensor_message</span> <span class="o">=</span> <span class="n">TensorMessage</span><span class="p">()</span>
<span class="n">empty_message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2018, Saad Khan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>