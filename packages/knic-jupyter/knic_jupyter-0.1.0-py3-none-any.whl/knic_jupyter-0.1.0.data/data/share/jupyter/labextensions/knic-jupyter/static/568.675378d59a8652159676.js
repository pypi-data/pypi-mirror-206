(self.webpackChunkknic_jupyter=self.webpackChunkknic_jupyter||[]).push([[568],{568:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>x});var o=n(123),i=n(526),a=n(780),r=n(248),s=n.n(r),l=n(155);const c="JUPYTER_LOADED",u="NOTEBOOK_OPENED",d="CELL_SELECTED",p="NOTEBOOK_MODIFIED",m="CELL_EXECUTION_BEGIN",g="CELL_EXECUTION_END",f=new Boolean(l.env.USE_DEXIE)||!1;let v,h="",N=!1;const S=new URLSearchParams(window.location.search).get("userid"),y=new URLSearchParams(window.location.search).get("sessionid"),w=l.env.LOGGING_ENDPOINT||`https://knic.isi.edu/engine/user/${S}/event`;let O,T=0,b=i.UUID.uuid4();function E(e){return{cellId:e.id,type:e.type,metadata:e.metadata,value:e.value.text}}async function k(e,t){const n=null==t?void 0:t.notebook.parent;if((null==t?void 0:t.cell.model)&&"code"===t.cell.model.type){const e=t.cell.model.toJSON(),o={eventData:{cell:E(t.cell.model),notebookName:n.context.path,location:window.location.toString(),executionCount:e.execution_count},enumeration:T++,notebookSession:b,eventName:m,user:S,session:y,timestamp:(new Date).toISOString()};console.log(m),console.log(JSON.stringify(o,null,2)),f&&await v.table("logs").add({eventName:m,data:JSON.stringify(o,null,2)}),s().post(w,encodeURI(JSON.stringify(o)),{headers:{"Content-Type":"application/json"}})}}async function D(e,t){const n=null==t?void 0:t.notebook.parent;if((null==t?void 0:t.cell.model)&&"code"===t.cell.model.type){const e=t.cell.model.toJSON(),o=e.outputs.map((e=>{if("error"===e.output_type){const t=e;return{errorName:t.ename,errorText:t.evalue,stackTrace:t.traceback}}return{errorName:"",errorText:"",stackTrace:[]}})).filter((e=>""!==e.errorName)),i=e.outputs.map((e=>"stream"===e.output_type?e.text:[])).filter((e=>e.length>0)),a={eventData:{cell:E(t.cell.model),notebookName:n.context.path,location:window.location.toString(),output:i,executionCount:e.execution_count,errors:o},enumeration:T++,notebookSession:b,eventName:g,session:y,user:S,timestamp:(new Date).toISOString()};console.log(g),console.log(JSON.stringify(a,null,2)),f&&await v.table("logs").add({eventName:g,data:JSON.stringify(a,null,2)}),s().post(w,encodeURI(JSON.stringify(a)),{headers:{"Content-Type":"application/json"}})}}async function I(e,t){t.content.modelContentChanged.connect(C),T=0,b=i.UUID.uuid4();const n={eventData:{notebookName:t.context.path,location:window.location.toString()},user:S,session:y,enumeration:T++,notebookSession:b,timestamp:(new Date).toISOString(),eventName:u};console.log(u),console.log(JSON.stringify(n,null,2)),f&&await v.table("logs").add({eventName:u,data:JSON.stringify(n,null,2)}),s().post(w,encodeURI(JSON.stringify(n)),{headers:{"Content-Type":"application/json"}})}async function C(e){O&&clearTimeout(O),O=setTimeout((async()=>{var t;const n=e.parent,o=[];if(null===(t=e.model)||void 0===t?void 0:t.cells)for(let t=0;t<e.model.cells.length;t++){const n=e.model.cells.get(t);o.push(E(n))}const i={eventData:{notebookName:n.context.path,location:window.location.toString(),cells:o},enumeration:T++,notebookSession:b,eventName:p,user:S,session:y,timestamp:(new Date).toISOString()};console.log(p),console.log(JSON.stringify(i,null,2)),f&&await v.table("logs").add({eventName:p,data:JSON.stringify(i,null,2)}),s().post(w,encodeURI(JSON.stringify(i)),{headers:{"Content-Type":"application/json"}})}),5e3)}async function J(e,t){var n;const o=null===(n=null==t?void 0:t.parent)||void 0===n?void 0:n.parent;if(h=o.context.path,null==t?void 0:t.model){const e={eventData:{cell:E(null==t?void 0:t.model),notebookName:o.context.path,location:window.location.toString()},enumeration:T++,notebookSession:b,eventName:d,user:S,session:y,timestamp:(new Date).toISOString()};console.log(d),console.log(JSON.stringify(e,null,2)),f&&await v.table("logs").add({eventName:d,data:JSON.stringify(e,null,2)}),s().post(w,encodeURI(JSON.stringify(e)),{headers:{"Content-Type":"application/json"}})}}const x={id:"knic-jupyter:plugin",autoStart:!0,requires:[o.INotebookTracker],activate:(e,t)=>{f&&(v=new a.Dexie("database"),v.version(1).stores({logs:"++id, eventName, data"})),console.log("knic-jupyter is activated!"),async function(){T=0,b=i.UUID.uuid4();const e={eventData:{location:window.location.toString()},user:S,session:y,enumeration:T++,notebookSession:b,timestamp:(new Date).toISOString(),eventName:c};f&&await v.table("logs").add({eventName:c,data:JSON.stringify(e,null,2)}),s().post(w,encodeURI(JSON.stringify(e)),{headers:{"Content-Type":"application/json"}})}(),t.widgetAdded.connect(I,void 0),t.activeCellChanged.connect(J,void 0),o.NotebookActions.executed.connect(D,void 0),o.NotebookActions.executionScheduled.connect(k,void 0),function(){const{webkitSpeechRecognition:e}=window,t=new e;t.continuous=!0,t.addEventListener("start",(()=>{console.log("speech recognition has started")})),t.addEventListener("error",(e=>{N="no-speech"!==e.error,console.error("speech error occured",e)})),t.addEventListener("end",(e=>{console.log("Speech recognition service disconnected, attempting to reconnect."),N?new Promise((e=>setTimeout(e,5e3))).then((()=>{t.start()})):t.start()})),t.onresult=e=>{const t=e.results[e.results.length-1][0].transcript,n={eventData:{notebookName:h,location:window.location.toString(),transcript:t.trim()},enumeration:T++,notebookSession:b,eventName:"SPEECH_DETECTED",user:S,session:y,timestamp:(new Date).toISOString()};console.log(JSON.stringify(n,null,2)),v.table("logs").add({eventName:m,data:JSON.stringify(n,null,2)}),s().post(w,encodeURI(JSON.stringify(n)),{headers:{"Content-Type":"application/json"}})},t.start()}()}}},155:e=>{var t,n,o=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function r(e){if(t===setTimeout)return setTimeout(e,0);if((t===i||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:i}catch(e){t=i}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(e){n=a}}();var s,l=[],c=!1,u=-1;function d(){c&&s&&(c=!1,s.length?l=s.concat(l):u=-1,l.length&&p())}function p(){if(!c){var e=r(d);c=!0;for(var t=l.length;t;){for(s=l,l=[];++u<t;)s&&s[u].run();u=-1,t=l.length}s=null,c=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{return n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function g(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new m(e,t)),1!==l.length||c||r(p)},m.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=g,o.addListener=g,o.once=g,o.off=g,o.removeListener=g,o.removeAllListeners=g,o.emit=g,o.prependListener=g,o.prependOnceListener=g,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}}}]);